---
import { WINNING_TECHNIQUES, getStadiumById, parseRaceCode } from "@fun-site/shared";
import type { RacePrediction } from "@fun-site/shared";
import ConfidenceStars from "../../../../components/ConfidenceStars.astro";
import EstimatesBadge from "../../../../components/EstimatesBadge.astro";
import PredictionImage from "../../../../components/PredictionImage.astro";
import RaceTable from "../../../../components/RaceTable.astro";
import ShareButton from "../../../../components/ShareButton.astro";
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import { loadAvailableDates, loadPredictions } from "../../../../lib/data";

export async function getStaticPaths() {
  const dates = await loadAvailableDates();
  const paths = [];

  for (const date of dates) {
    const predictions = await loadPredictions(date);
    for (const prediction of predictions) {
      const parsed = parseRaceCode(prediction.raceCode);
      paths.push({
        params: {
          date: parsed.date,
          stadiumId: parsed.stadiumId,
          raceNumber: String(prediction.raceNumber),
        },
        props: { prediction },
      });
    }
  }

  return paths;
}

interface Props {
  prediction: RacePrediction;
}

const { prediction } = Astro.props;
const stadium = getStadiumById(parseRaceCode(prediction.raceCode).stadiumId);
const stadiumName = stadium?.name ?? prediction.stadium;
const techniqueName = WINNING_TECHNIQUES[prediction.aiPrediction.predictedTechnique] ?? prediction.aiPrediction.predictedTechnique;
const title = `${stadiumName} ${prediction.raceNumber}R - 展開予想`;
const shareText = `${stadiumName} ${prediction.raceNumber}R 展開予想: ${techniqueName} ${prediction.aiPrediction.predictedOrder.slice(0, 3).join("-")}`;
const siteUrl = Astro.site?.toString() ?? "";
const pageUrl = new URL(Astro.url.pathname, siteUrl).toString();
const jsonLd = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": `${stadiumName} ${prediction.raceNumber}R の展開予想。決まり手: ${techniqueName}、予想着順: ${prediction.aiPrediction.predictedOrder.slice(0, 3).join("-")}`,
  "datePublished": prediction.createdAt,
  "url": pageUrl,
  ...(prediction.ogImageUrl ? { "image": prediction.ogImageUrl } : {}),
  "author": { "@type": "Organization", "name": "BoatRace AI" },
  "publisher": { "@type": "Organization", "name": "BoatRace AI" },
});
---

<BaseLayout title={title} ogImage={prediction.ogImageUrl || undefined}>
  <nav class="text-sm text-gray-500 mb-4">
    <a href="/" class="hover:text-blue-600">トップ</a>
    <span class="mx-1">/</span>
    <span>{stadiumName}</span>
    <span class="mx-1">/</span>
    <span>{prediction.raceNumber}R</span>
  </nav>

  <h1 class="text-2xl font-bold mb-2">{stadiumName} {prediction.raceNumber}R</h1>
  <p class="text-gray-500 text-sm mb-6">{prediction.raceDate}</p>

  <!-- 展開予想画像 -->
  {prediction.imageUrl && (
    <div class="mb-6">
      <PredictionImage
        imageUrl={prediction.imageUrl}
        imageType={prediction.imageType}
        alt={`${stadiumName} ${prediction.raceNumber}R 展開予想図`}
      />
    </div>
  )}

  <!-- 予想サマリ -->
  <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-3">
        <span class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">
          {techniqueName}
        </span>
        <span class="font-mono text-lg font-bold">
          {prediction.aiPrediction.predictedOrder.slice(0, 3).join("-")}
        </span>
      </div>
      <ConfidenceStars confidence={prediction.aiPrediction.confidence} />
    </div>
    <EstimatesBadge ml={prediction.mlPrediction} />
  </div>

  <!-- 出走表 -->
  {prediction.boats.length > 0 && (
    <section class="bg-white rounded-lg shadow-sm p-4 mb-6">
      <h2 class="font-bold text-lg mb-3">出走表</h2>
      <RaceTable boats={prediction.boats} />
    </section>
  )}

  <!-- AI展開解説 -->
  <section class="bg-white rounded-lg shadow-sm p-4 mb-6">
    <h2 class="font-bold text-lg mb-3">展開予想</h2>
    <p class="text-gray-700 leading-relaxed whitespace-pre-line">
      {prediction.aiPrediction.narrative}
    </p>
    {prediction.aiPrediction.firstTurnScenario && (
      <div class="mt-3 bg-blue-50 rounded p-3 text-sm text-blue-800">
        <span class="font-semibold">1マーク展開:</span> {prediction.aiPrediction.firstTurnScenario}
      </div>
    )}
  </section>

  <!-- 推奨買い目 -->
  {prediction.aiPrediction.suggestedBets.length > 0 && (
    <section class="bg-white rounded-lg shadow-sm p-4 mb-6">
      <h2 class="font-bold text-lg mb-3">推奨買い目（3連単）</h2>
      <div class="flex flex-wrap gap-2">
        {prediction.aiPrediction.suggestedBets.map((bet) => (
          <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded font-mono text-sm">
            {bet}
          </span>
        ))}
      </div>
    </section>
  )}

  <!-- SNS共有 -->
  <div class="flex justify-center">
    <ShareButton text={shareText} url={Astro.url.toString()} />
  </div>

  <!-- JSON-LD 構造化データ -->
  <script is:inline type="application/ld+json" set:html={jsonLd} />
</BaseLayout>
