# ボートレース ドメイン知識整理 & コンテンツ方針提案

## 1. レース展開予想に必要なデータ一覧と優先度

### 優先度A（必須・AM2:00バッチで取得可能）

データソース: BoatraceCSV Programs CSV (`data/programs/YYYY/MM/DD.csv`)

| データ項目 | 説明 | BoatraceCSV カラム |
|---|---|---|
| 枠番（艇番） | 1〜6号艇。枠番＝コースとほぼ一致（1号艇の1コース取得率98.7%） | `艇番` |
| 選手級別 | A1, A2, B1, B2の4段階 | `級別` |
| 全国勝率 | 選手の全国勝率 | `全国勝率` |
| 全国2連対率 | 選手の全国2連対率 | `全国2連対率` |
| 当地勝率 | 当該競艇場での勝率 | `当地勝率` |
| 当地2連対率 | 当該競艇場での2連対率 | `当地2連対率` |
| モーター2連対率 | 現在のモーターの成績 | `モーター2連対率` |
| ボート2連対率 | 現在のボートの成績 | `ボート2連対率` |
| 選手体重 | 軽い方が有利（特にモーニング・ナイター） | `体重` |
| 今節成績 | 節間の調子（最大6レース分） | `今節成績1`〜`今節成績6` |
| レース名 | レースのグレード・種別を判別 | `レース名` |
| 距離 | 通常1800m | `距離` |

### 優先度A+（ML予測・AM2:00バッチで取得可能）

BoatraceCSV には scikit-learn ベースの ML 予測結果が含まれており、AM2:00 時点で直前情報の代替として活用可能。

#### Prediction Previews CSV (`data/prediction-preview/YYYY/MM/DD.csv`)

ML による展示会予測。Previews CSV（直前情報）が未公開の AM2:00 時点での代替データ。

| データ項目 | 説明 | BoatraceCSV カラム |
|---|---|---|
| 予測コース | 各艇の予測進入コース（ハンガリアンアルゴリズム） | `艇N_コース` |
| 予測ST | 予測スタートタイミング（回帰モデル） | `艇N_スタート展示` |
| 予測チルト | 予測チルト調整値 | `艇N_チルト調整` |
| 予測展示タイム | 予測展示タイム（回帰モデル） | `艇N_展示タイム` |

#### Estimates CSV (`data/estimate/YYYY/MM/DD.csv`)

ML による着順・決まり手予想。

| データ項目 | 説明 | BoatraceCSV カラム |
|---|---|---|
| 予想着順 | ML予測の1〜3着 | `予想1着`, `予想2着`, `予想3着` |
| 予想決まり手 | LightGBM による決まり手分類 | `予想決まり手` |
| 予想コース | 各艇の予想進入コース | `艇N_予想コース` |
| 予想ST | 各艇の予想スタートタイミング | `艇N_予想ST` |

### 優先度B（直前情報・AM2:00時点では未取得）

データソース: BoatraceCSV Previews CSV (`data/previews/YYYY/MM/DD.csv`) — レース当日の展示航走後に公開

| データ項目 | 説明 | 備考 |
|---|---|---|
| 展示タイム | 本番前の試走タイム | 当日のモーター調子の直接指標 |
| スタート展示 | 試走でのスタートタイミング | 実際のスタート力の指標 |
| チルト角度 | プロペラの角度調整 | 選手のセッティング意図を反映 |
| 進入コース | 実際のコース取り（枠なり or 前付け） | 枠番と異なる場合がある |
| 風向・風速 | レース時の風況 | 展開に大きく影響 |
| 波高 | 水面状態 | 荒れると波乱要因 |

**注**: AM2:00 バッチでは Previews CSV は未公開だが、Prediction Previews CSV（ML予測）で展示タイム・進入コース・STを予測値として補完可能。

### 優先度C（外部データ・独自集計が必要）

| データ項目 | 説明 | データソース |
|---|---|---|
| 選手コース別成績 | 各コースでの勝率・決まり手傾向 | ボートレース日和、艇国データバンク等 |
| 競艇場別1コース勝率 | 場ごとの特性（イン天国/地獄） | 艇国データバンク |
| 新概念データ | 選手の決まり手別回数・確率 | BOATBoy WEB |

---

## 2. 展開予想画像のコンテンツ設計方針

### 2.1 画像で表現する内容

#### メイン画像：1マーク展開図

1マーク（第1ターンマーク）の攻防でほぼ勝敗が決まるため、これが最重要コンテンツ。

**描画要素：**
- 6艇の位置関係（スタート隊形 → 1マーク旋回）
- 各艇の色（1白, 2黒, 3赤, 4青, 5黄, 6緑）
- 予想される決まり手の動線（矢印・軌跡）
- 本命艇のハイライト

#### 決まり手パターン（画像テンプレート化推奨）

| 決まり手 | 説明 | 発生条件 |
|---|---|---|
| **イン逃げ** | 1コースがそのまま先行して逃げ切り | 1コースの選手がA1級、モーター好調、追い風 |
| **差し** | 内側から2〜3コースが差す | 1コースがターンで膨らんだ場合、2コースの差し実績が高い選手 |
| **まくり** | 外側（主に3〜4コース）から一気にまくる | カド（4コース）のスタートが早い、向かい風 |
| **まくり差し** | 外からまくりつつ内を差す | 高度な技術が必要、A1級の実力者に多い |
| **抜き** | 2周目以降に逆転 | モーター性能差が大きい場合 |
| **恵まれ** | 前の艇の失敗で繰り上がり | 転覆・落水・エンスト |

#### スリット隊形パターン（3種）

| 隊形 | 特徴 | よくある展開 |
|---|---|---|
| **横一線** | 全艇がほぼ同時にスリットを通過 | イン逃げ or 差し |
| **内凹み** | インがスタート遅れ、外が出る | まくり or まくり差し |
| **外凹み** | アウトがスタート遅れ | イン逃げ確率UP |

### 2.2 生成AI画像の方針

**採用アプローチ：Gemini 3 Pro による画像生成 + SVGフォールバック**

1. **Gemini 3 Pro で展開図画像を生成**（メイン）: Thinking モードによる論理的な艇配置、鳥瞰図スタイルのレース展開図
2. **Gemini 3 Pro でSVGコードを生成**（フォールバック）: 正確な配置・再現性100%の図解
3. **品質チェック Agent で検証**: 6艇描画・色・テキスト可読性・レイアウト
4. **テキスト情報はHTML側で表示**: 日本語テキストの画像内描画リスクを回避、画像は図解（位置関係・動線・色分け）に専念

**理由：**
- Gemini 3 Pro の Thinking モードで展開ロジックに基づいた配置が可能
- SVGフォールバックにより、AI画像品質が不安定でもコンテンツ提供を保証
- Imagen は展開図（ダイアグラム）生成に不向きなため不採用

### 2.3 コンテンツ構成案（1レースあたり）

```
┌─────────────────────────────────────┐
│ レースヘッダー                        │
│ [場名] [レースNo] [グレード] [時刻]     │
├─────────────────────────────────────┤
│ 展開予想画像（1マーク攻防図）            │
│ ┌───────────────────────────────┐   │
│ │  スタート隊形 → 1マーク旋回図   │   │
│ │  決まり手: イン逃げ             │   │
│ │  信頼度: ★★★★☆               │   │
│ └───────────────────────────────┘   │
├─────────────────────────────────────┤
│ 出走表（6艇の主要データ）              │
│ 艇番 | 選手名 | 級別 | 勝率 | ST | モーター │
├─────────────────────────────────────┤
│ ML予測 (Estimates CSV)               │
│ 予想着順 | 予想決まり手 | 予想コース      │
├─────────────────────────────────────┤
│ AI展開解説テキスト (Gemini 3 Pro)      │
│ - 注目ポイント                       │
│ - 推奨買い目（3連単 5〜10点）          │
├─────────────────────────────────────┤
│ SNS共有ボタン                        │
└─────────────────────────────────────┘
```

---

## 3. 対象レース選定の推奨方針

### 採用方針：シナリオ3（最小構成）

各場1レースのみ、1日あたり最大12レースを処理。

**選定基準（優先度順）：**
1. SG/GI/GII レースが開催中の場 → そのメインレース（通常12R）
2. 上記以外 → 各場の12R（最終レース = メインレース）

### 段階的拡大ロードマップ

| Phase | 対象 | レース数/日 |
|---|---|---|
| Phase 1（MVP） | 各場12Rのみ | 最大12レース |
| Phase 2 | 各場10R〜12R + SG/GI全レース | 最大72レース |
| Phase 3 | 全場全レース | 最大288レース |

### 競艇場の特性による分類（コンテンツ方針に活用）

#### イン天国（予想しやすい・初心者向け）
| 場 | 1コース1着率 | 特徴 |
|---|---|---|
| 大村 | ~65-70% | 全国1位。企画レースが多い |
| 徳山 | ~60% | コース広い、待機行動短い |
| 芦屋 | ~58% | サンライズV戦のイン勝率90%弱 |
| 下関 | ~57% | 独特のコース形状でイン有利 |

#### 波乱場（穴狙い・上級者向け）
| 場 | 1コース1着率 | 特徴 |
|---|---|---|
| 戸田 | ~43% | 全国最狭水面（107.5m）|
| 江戸川 | ~44% | 唯一の河川コース、風と潮で大荒れ |
| 平和島 | ~45% | 風向・風速が不安定 |
| びわこ | ~47% | 高地で気圧低い、モーター出力↓ |

---

## 4. AM2:00バッチの制約と対策

### 制約の整理

| 項目 | AM2:00時点の状況 | 影響 |
|---|---|---|
| Programs CSV（出走表） | ✅ 取得可能（前日夕方〜夜に公開） | 選手・モーターデータは利用可能 |
| Prediction Previews CSV（ML展示会予測） | ✅ 取得可能 | 展示タイム・進入コース・STの予測値が利用可能 |
| Estimates CSV（ML着順予想） | ✅ 取得可能 | 着順予測・決まり手予測が利用可能 |
| Previews CSV（直前情報） | ❌ 未公開（レース当日の展示航走後） | 実測の展示タイム、進入コース、風況は使えない |
| オッズ | ❌ 未公開（発売開始後） | 人気度判定はできない |

### AM2:00 バッチで利用可能なデータ

| データ | ソース | 信頼度 |
|---|---|---|
| 選手の級別・全国勝率・当地勝率 | Programs CSV | 高 |
| モーター2連対率・ボート2連対率 | Programs CSV | 高 |
| 今節成績 | Programs CSV | 高 |
| ML予測の着順・決まり手 | Estimates CSV | 中〜高 |
| ML予測の進入コース・ST | Estimates CSV / Prediction Previews CSV | 中 |
| ML予測の展示タイム | Prediction Previews CSV | 中 |

### AM2:00 バッチで利用できないデータ

- 実測の展示タイム（当日のモーター調子の直接指標）
- 実際のスタート展示の進入コース（前付け有無）
- 当日の風向・風速・波高
- オッズ

### 対策

**BoatraceCSV の Prediction Previews + Estimates で直前情報を補完**

AM2:00 時点で Previews CSV（実測直前情報）は未公開だが、BoatraceCSV には ML による予測版が含まれている:

- **Prediction Previews CSV**: Programs データから進入コース・ST・展示タイムを回帰モデルで予測
- **Estimates CSV**: LambdaRank + Random Forest で着順予測、LightGBM で決まり手分類

これにより、AM2:00 バッチのみで十分な予想根拠を確保できる。将来的に Previews CSV が公開された後の差分更新バッチで精度向上も可能。

---

## 5. コンテンツ更新戦略

### 日次コンテンツサイクル

```
[AM 2:00] メインバッチ
  │
  ├── 1. BoatraceCSV からデータ取得
  │     ├── Programs CSV → 当日出走表
  │     ├── Prediction Previews CSV → ML予測による展示会予測
  │     ├── Estimates CSV → ML予測（着順・決まり手・コース・ST）
  │     ├── 前日 Results CSV → 前日レース結果
  │     └── 前日 Confirmations CSV → 前日予想の答え合わせ
  │
  ├── 2. 予想分析 Agent (Gemini 3 Pro)
  │     ├── 入力: Programs + Prediction Previews + Estimates
  │     ├── ML予測結果を踏まえた展開シナリオ分析
  │     └── 出力: 構造化展開予想テキスト (JSON)
  │
  ├── 3. 画像生成 Agent (Gemini 3 Pro)
  │     ├── 展開予想テキスト → レース展開図画像 (PNG)
  │     └── 同時にSVGフォールバック版を生成
  │
  ├── 4. 品質チェック Agent (Gemini 3 Pro)
  │     ├── 生成画像を検証（6艇・色・テキスト・レイアウト）
  │     └── 不合格 → リトライ or SVGフォールバック
  │
  ├── 5. 静的ページ生成 (Astro SSG)
  │     ├── トップページ（当日の開催一覧 + 注目レース）
  │     ├── 場別ページ（対象レースの予想）
  │     └── 個別レースページ（展開予想詳細）
  │
  └── 6. Cloud Storage へデプロイ

[将来拡張] 直前更新バッチ
  │
  ├── 1. Previews CSV（実測直前情報）取得
  ├── 2. 展開予想の更新（実測値で精度向上）
  └── 3. 差分デプロイ

[将来拡張] 結果反映バッチ
  │
  ├── 1. Results CSV → レース結果取得
  ├── 2. Confirmations CSV → 予想の答え合わせ
  │     ├── 的中率の集計
  │     └── 展開予想 vs 実際の展開の比較
  └── 3. 差分デプロイ
```

### SEO・集客戦略

| 施策 | 内容 |
|---|---|
| ページ構造 | `/race/{date}/{stadiumId}/{raceNum}` の階層URL |
| OGP画像 | 展開予想画像をそのままOGP画像に設定 |
| 構造化データ | JSON-LDでレース情報をマークアップ |
| 更新頻度 | 毎日新規ページ生成でクロール頻度を維持 |
| キーワード | 「[場名] [日付] [レース番号] 予想」で検索流入を狙う |

### データソースまとめ

| CSV種別 | URL パターン | AM2:00 | 用途 |
|---|---|---|---|
| Programs | `boatracecsv.github.io/data/programs/YYYY/MM/DD.csv` | ✅ | 出走表 |
| Prediction Previews | `boatracecsv.github.io/data/prediction-preview/YYYY/MM/DD.csv` | ✅ | ML展示会予測 |
| Estimates | `boatracecsv.github.io/data/estimate/YYYY/MM/DD.csv` | ✅ | ML着順予想 |
| Previews | `boatracecsv.github.io/data/previews/YYYY/MM/DD.csv` | ❌ | 直前情報（将来拡張） |
| Results | `boatracecsv.github.io/data/results/YYYY/MM/DD.csv` | 前日分✅ | レース結果 |
| Confirmations | `boatracecsv.github.io/data/confirm/YYYY/MM/DD.csv` | 前日分✅ | 的中確認 |

---

## 参考情報源

- [BoatraceCSV (GitHub)](https://github.com/BoatraceCSV/boatracecsv.github.io)
- [BOAT RACE 公式サイト](https://www.boatrace.jp/)
- [艇国データバンク - 場別1コース成績](https://boatrace-db.net/stadium/acourse/course/1/)
- [ボートレース日和](https://kyoteibiyori.com)
- [中日スポーツ - 展開の統計構造分析](https://static.chunichi.co.jp/chuspo/pages/feature/kyotei/statistical_structure_of_uncertainties_in_boat_races.html)
- [BOATBoy WEB - 新概念データ](https://www.boatboy.jp/forecast-data/shingainen-data/)
- [競艇ナビ - 予想の仕方](https://kyoutei-navi.com/beginner/yosou/)
