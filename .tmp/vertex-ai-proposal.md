# Vertex AI 活用方針提案書

## 1. モデル選定

### 1.1 統一モデル: Gemini 3 Pro

| 項目 | 内容 |
|------|------|
| モデル | `gemini-3-pro` |
| 用途 | テキスト分析・画像生成・品質チェック・SVGフォールバック |
| 選定理由 | 高い推論能力、ネイティブ画像生成、Thinkingモード対応、マルチモーダル入出力 |

本プロジェクトでは **Gemini 3 Pro を単一モデルとして全工程に採用** する。テキスト分析、画像生成、品質チェック、SVG生成をすべて同一モデルで処理することで、モデル管理の複雑性を排除し、一貫した品質を確保する。

#### テキスト分析（予想分析Agent）

- BoatraceCSV の Programs + Prediction Previews + Estimates を入力
- ML予測結果（LambdaRank + Random Forest アンサンブル、LightGBM 決まり手分類）を踏まえた展開シナリオ分析
- 構造化された展開予想テキスト（JSON）を出力

#### 画像生成（画像生成Agent）

- 展開予想テキストからプロンプト生成
- Thinking モードによる論理的な艇配置
- レース展開図（鳥瞰図スタイル）を PNG 出力

#### 品質チェック（品質チェックAgent）

- マルチモーダル入力で生成画像を検証:
  - 6艇すべてが描画されているか
  - 艇番の色が正しいか（1白, 2黒, 3赤, 4青, 5黄, 6緑）
  - テキストが読み取り可能か
  - レイアウトが破綻していないか
- 不合格 → リトライ or SVGフォールバック

#### SVGフォールバック

- 画像品質が基準を満たさない場合、SVGコードを生成
- 正確な配置・再現性100%で確実にコンテンツ提供

### 1.2 Imagen を採用しない理由

- ダイアグラム・図解の生成に不向き（写真的リアリズム特化）
- テキスト描画精度が低い
- 空間配置の正確な制御ができない
- レース展開図というユースケースに適合しない

### 1.3 Gemini 2.5 Flash を採用しない理由

- Gemini 3 Pro と比較して推論能力が劣る
- 画像生成品質（特にダイアグラム・配置の正確さ）で差がある
- コスト削減より品質を優先する判断
- 対象レース数を絞ることでコスト管理が可能

---

## 2. データソース: BoatraceCSV

### 2.1 概要

GitHub Pages で配信される CSV データのみを使用する。外部 API への依存はなく、安定したデータ取得が可能。

**URL パターン**: `https://boatracecsv.github.io/data/{type}/YYYY/MM/DD.csv`

### 2.2 利用する CSV 種別

| CSV種別 | パス | AI パイプラインでの用途 | AM2:00時点 |
|---|---|---|---|
| Programs | `data/programs/YYYY/MM/DD.csv` | 出走表データ（選手・モーター・成績） → 予想分析の入力 | 取得可能 |
| Prediction Previews | `data/prediction-preview/YYYY/MM/DD.csv` | ML予測による展示会予測 → 直前情報の代替 | 取得可能 |
| Estimates | `data/estimate/YYYY/MM/DD.csv` | ML予測（着順・決まり手・コース・ST） → 予想分析の参考 | 取得可能 |
| Results | `data/results/YYYY/MM/DD.csv` | 前日結果 → 的中実績・傾向分析 | 前日分取得可能 |
| Confirmations | `data/confirm/YYYY/MM/DD.csv` | 予想と結果の対比 → 精度モニタリング | 前日分取得可能 |

### 2.3 ML予測の活用

BoatraceCSV には scikit-learn ベースの ML 予測結果が含まれている。Gemini 3 Pro はこれらの ML 予測結果を入力として受け取り、さらに深い分析を加える。

| ML予測 | アルゴリズム | Gemini 3 Pro での活用 |
|---|---|---|
| 着順予測 | LambdaRank + Random Forest | 展開シナリオの根拠データとして利用 |
| 決まり手分類 | LightGBM | 展開パターン選択の参考 |
| 進入コース予測 | ハンガリアンアルゴリズム | スタート隊形の推定 |
| ST予測 | 回帰モデル | スタートタイミングの推定 |

---

## 3. Agentic AI アーキテクチャ

### 3.1 エージェント構成

```
┌──────────────────────────────────────────────────┐
│          オーケストレーター (Cloud Run Job)         │
│          毎日 AM 2:00 実行                         │
└───────┬──────────────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────────────────┐
│         データ取得                                  │
│   BoatraceCSV から 5種 CSV を取得                  │
│   Zod バリデーション → 構造化データ                  │
└──────────────────┬───────────────────────────────┘
                   │
                   ▼ (各場1レースを選択)
┌──────────────────────────────────────────────────┐
│         予想分析 Agent (Gemini 3 Pro)               │
│   入力: Programs + Prediction Previews + Estimates │
│   出力: 構造化展開予想テキスト (JSON)                │
└──────────────────┬───────────────────────────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────┐
│         画像生成 Agent (Gemini 3 Pro)               │
│   入力: 展開予想テキスト + プロンプトテンプレート     │
│   出力: レース展開予想画像 (PNG)                     │
│   同時に SVGフォールバック版も生成                    │
└──────────────────┬───────────────────────────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────┐
│         品質チェック Agent (Gemini 3 Pro)            │
│   入力: 生成画像 + 展開予想テキスト                  │
│   出力: 合否判定 + 修正指示                          │
│   不合格 → 画像生成 Agent にリトライ指示             │
│   最大リトライ超過 → SVGフォールバック採用            │
└──────────────────┬───────────────────────────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────┐
│         ページ生成 (Astro SSG)                      │
│   入力: 画像 + テキスト + テンプレート               │
│   出力: 静的HTML                                    │
│   → Cloud Storage にアップロード                    │
└──────────────────────────────────────────────────┘
```

### 3.2 対象レースの選定ロジック

**各場1レースのみ（シナリオ3: 最小構成）** を採用。1日あたり最大12レースを処理。

選定基準（優先度順）:
1. SG/GI/GII レースが開催中の場 → そのメインレース（通常12R）
2. 上記以外 → 各場の12R（最終レース = メインレース）

### 3.3 Vertex AI Agent Builder の扱い

**不採用**。

理由:
- Agent Builder は対話型エージェント向け（チャットボット等）に最適化されている
- 本プロジェクトはバッチ処理（1日1回、非対話型）
- ランタイムコスト（$0.0864/vCPU-hr）が不要なオーバーヘッドとなる
- Cloud Run Jobs + Vertex AI SDK での直接 API 呼び出しの方がシンプルで安価

### 3.4 Agentic AI としてのハッカソン審査アピール

1. **自律的判断**: 品質チェック Agent が自律的に画像の合否を判定し、リトライを決定
2. **マルチエージェント連携**: 分析 → 生成 → 検証のパイプラインで複数 Agent が協調
3. **Tool Use**: 各 Agent が Vertex AI API、Cloud Storage API 等のツールを使用
4. **フィードバックループ**: 品質チェック → 再生成のループが自律的に動作
5. **冗長性設計**: AI画像 + SVGフォールバックの2系統で確実にコンテンツ提供

---

## 4. プロンプト設計

### 4.1 予想分析プロンプト

```
あなたはボートレースの展開予想の専門家です。
以下の出走表データとML予測結果を分析し、レース展開を予想してください。

## 出走表データ (Programs CSV)
{出走表CSV: 枠番, 選手名, 級別, 全国勝率, 当地勝率, モーター2連率, 展示タイム, ST平均...}

## ML予測: 展示会予測 (Prediction Previews CSV)
{各艇の予測コース, 予測ST, 予測展示タイム}

## ML予測: 着順予想 (Estimates CSV)
{予想1〜3着, 予想決まり手, 各艇の予想コース・予想ST}

## 出力形式（JSON）
{
  "start_formation": {
    "course_entry": [進入コース順],
    "start_timing": {"1": 0.15, "2": 0.18, ...}
  },
  "first_turn": {
    "leading_boat": 1,
    "attack_type": "逃げ",
    "key_battle": "3号艇のまくり vs 1号艇の逃げ"
  },
  "winning_move": "逃げ",
  "predicted_order": [1, 3, 4, 2, 5, 6],
  "confidence": 0.72,
  "narrative": "1号艇○○選手がインから好スタートを決め..."
}
```

### 4.2 画像生成プロンプト

#### 図解スタイル（メイン）

```
ボートレースの展開予想図を生成してください。鳥瞰図の視点で、以下の要素を含めてください。

【レイアウト】
- 水面を上から見た図（青い水面）
- 左側にスタートライン、右側に1マーク（ターンマーク）
- 反時計回りのコースレイアウト

【6艇の配置と色】
- 1号艇（白）: コース1、ST 0.15秒 → 先頭で1マークへ
- 2号艇（黒）: コース2、ST 0.20秒 → やや遅れ
- 3号艇（赤）: コース3、ST 0.14秒 → まくり体勢
- 4号艇（青）: コース4、ST 0.19秒 → 中団
- 5号艇（黄）: コース5、ST 0.22秒 → 後方
- 6号艇（緑）: コース6、ST 0.25秒 → 最後方

【表示テキスト】
- 各艇に番号ラベル
- 予想決まり手: 「逃げ」
- レースタイトル: 「{場名} 第{X}レース 展開予想」

【スタイル】
- スポーツ解説図風のクリーンなイラスト
- 矢印で各艇の進行方向を示す
- 背景は濃い青のグラデーション
```

### 4.3 品質チェックプロンプト

```
あなたはボートレース展開予想図の品質検査官です。
以下の画像が品質基準を満たしているか検証してください。

## 品質基準
1. 6艇すべてが描画されているか
2. 各艇の色が正しいか（1白, 2黒, 3赤, 4青, 5黄, 6緑）
3. 水面・コースのレイアウトが適切か
4. テキスト（艇番・レースタイトル）が読み取り可能か
5. 全体のレイアウトが破綻していないか
6. 予想テキストの内容と画像の配置が矛盾していないか

## 展開予想テキスト（参照用）
{展開予想テキストJSON}

## 出力形式（JSON）
{
  "passed": true/false,
  "score": 0-100,
  "issues": ["問題点1", "問題点2"],
  "retry_instruction": "修正指示（不合格時のみ）"
}
```

### 4.4 プロンプトテンプレート設計方針

- **テンプレート化**: 展開パターン（逃げ、差し、まくり等）ごとにベーステンプレートを用意
- **動的パラメータ**: 各レースの予想結果に基づいてテンプレートの変数を置換
- **一貫性確保**: スタイル指定部分を共通化し、画像の統一感を維持
- **Few-shot**: 理想的な出力画像の例を参照画像として入力

---

## 5. 画像生成アプローチ

### 5.1 ハイブリッド戦略

```
Phase 1: Gemini 3 Pro で展開予想テキスト生成
    ↓
Phase 2a: Gemini 3 Pro で展開図画像を生成（メイン画像）
Phase 2b: Gemini 3 Pro でSVGコードを生成（フォールバック）
    ↓
Phase 3: Gemini 3 Pro マルチモーダルで品質チェック
    - 画像品質OK → 画像版を採用
    - 画像品質NG → リトライ（最大2回）
    - リトライ超過 → SVGフォールバック採用
    ↓
Phase 4: HTMLページに画像 + SVG図 + テキスト解説の3点を配置
```

### 5.2 アプローチ比較

| アプローチ | 技術 | 長所 | 短所 |
|-----------|------|------|------|
| **A. Gemini 3 Pro 図解生成（採用）** | Gemini 3 Pro | Thinkingモードで論理的配置、テキスト描画正確、推論力あり | 精密な座標制御は不得意 |
| **B. SVGプログラム生成（フォールバック）** | Gemini 3 Pro → SVG/HTML | 完全に正確な配置、再現性100% | イラスト的な魅力に欠ける |
| **C. Imagen写真風（不採用）** | Imagen 4 | 写真的リアリズム | 構造的な配置制御不可、テキスト不正確 |

### 5.3 日本語テキストの扱い

AI画像内の日本語テキスト描画は品質リスクがあるため、テキスト情報は HTML 側で表示し、画像は図解（位置関係・動線・色分け）に専念する。

---

## 6. コスト概算

### 6.1 生成対象: シナリオ3（最小構成）

各場1レースのみ、1日あたり最大12レースを処理。

| 項目 | 数量 | 備考 |
|------|------|------|
| 開催場数 | 最大24場（通常6〜12場） | 日によって異なる |
| 1場あたり対象レース数 | 1レース | メインレースのみ |
| 1日の処理レース数 | 最大12レース（通常6〜12） | |

### 6.2 1日あたりの API コスト

| 処理 | 用途 | 数量/日 | 概算コスト/日 |
|------|------|---------|--------------|
| 展開予想テキスト生成 | 予想分析 Agent | 12 | ~$0.12 |
| 画像生成 | 画像生成 Agent | 12 | ~$1.61 |
| SVG生成（並行） | フォールバック | 12 | ~$0.12 |
| 品質チェック | 品質チェック Agent | 12 | ~$0.12 |
| リトライ（20%想定） | 画像再生成 | 2〜3 | ~$0.40 |
| **Vertex AI 合計** | | | **~$2.37/日** |

### 6.3 月額コスト概算

| 項目 | 月額 |
|------|------|
| Vertex AI (Gemini 3 Pro) | ~$71 |
| Cloud Run Jobs | ~$5 |
| Cloud Storage | ~$1〜3 |
| Cloud Scheduler | 無料 |
| Cloud CDN + Load Balancer | ~$5〜10 |
| Cloud Domains | ~$1 |
| **合計** | **~$83〜90** |

### 6.4 スケーリング時の参考コスト

将来的に対象レースを拡大する場合の参考値:

| 構成 | レース数/日 | Vertex AI 月額 | インフラ月額 | 合計 |
|------|------------|---------------|------------|------|
| **最小構成（採用）** | ~12 | ~$71 | ~$12〜19 | **~$83〜90** |
| 注目レースのみ | ~36 | ~$180 | ~$20 | ~$200 |
| 全場全レース | ~288 | ~$1,400 | ~$40 | ~$1,440 |

### 6.5 ハッカソン期間のコスト削減

- CDN / Load Balancer なしで Cloud Storage 直接公開 URL を使用 → インフラコストを大幅削減
- 開催場数が少ない日は処理数も少なくなるため、平均的な日額は概算より低くなる

---

## 7. 実装ロードマップ

### Phase 1: MVP（ハッカソン提出用）

- BoatraceCSV からデータ取得（Programs + Prediction Previews + Estimates）
- Gemini 3 Pro で展開予想テキスト生成
- Gemini 3 Pro で画像生成
- 各場1レース（12R）のみ対象
- 品質チェックは人手で確認
- Astro SSG でページ生成 → Cloud Storage にデプロイ

### Phase 2: Agentic 構成

- 品質チェック Agent 追加（マルチモーダルによる画像検証）
- SVGフォールバック生成
- リトライロジック（最大2回 → SVGフォールバック）
- 的中実績ページ（Confirmations CSV ベース）
- OGP画像対応

### Phase 3: 拡張

- 対象レースの拡大（注目レース全レース → 全場全レース）
- 直前情報反映バッチ（Previews CSV 公開後に差分更新）
- プロンプト最適化（品質向上・コスト削減）

---

## 8. 技術的リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| AI画像の品質が不安定 | ユーザー体験低下 | SVGフォールバック + 品質チェック Agent |
| 6艇の色の正確な表現が困難 | 誤情報 | プロンプトで色を明示指定 + 品質チェック |
| 日本語テキストの画像内描画不良 | 可読性低下 | テキストはHTML側で表示、画像は図解のみ |
| Gemini 3 Pro のコスト | 月額高騰 | 対象レース数の絞り込み（シナリオ3）で管理 |
| BoatraceCSV の更新遅延 | データ未取得 | リトライ + 前日データでのフォールバック |
| API レート制限 | バッチ処理停止 | 指数バックオフリトライ + 並行度制限 |
| Gemini 3 Pro の利用制限 | モデルアクセス不可 | プレビュー段階の制約に注意、GA後に安定化 |

---

## 9. まとめ

### 推奨構成

| コンポーネント | 技術 |
|---------------|------|
| テキスト分析 | Gemini 3 Pro |
| 画像生成 | Gemini 3 Pro（ネイティブ画像生成） |
| 品質チェック | Gemini 3 Pro（マルチモーダル） |
| SVGフォールバック | Gemini 3 Pro → SVG生成 |
| データソース | BoatraceCSV（GitHub Pages 配信 CSV） |
| 対象レース | 各場1レース（~12レース/日） |
| オーケストレーション | Cloud Run Jobs + Node.js |
| Agent Builder | **不採用**（バッチ処理には不適） |

### 最重要ポイント

1. **Gemini 3 Pro に統一** — テキスト分析・画像生成・品質チェック・SVGフォールバックをすべて単一モデルで処理。管理の簡素化と一貫した品質を実現
2. **BoatraceCSV のみ** — GitHub Pages 配信の CSV データのみを使用。ML予測結果（Estimates, Prediction Previews）も含まれており、外部 API 依存なし
3. **シナリオ3（最小構成）** — 各場1レースのみ（~12レース/日）でコストを月額 ~$83〜90 に抑制。品質を優先しつつ現実的なコスト管理
4. **SVGフォールバックで冗長性確保** — AI画像品質が不安定でもコンテンツ提供を保証
5. **Imagen は不採用** — 展開図・ダイアグラムの生成には Gemini 3 Pro が適切
